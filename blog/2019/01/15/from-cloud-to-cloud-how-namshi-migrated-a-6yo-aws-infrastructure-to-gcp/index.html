<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=0">
    <title>From cloud to cloud: how Namshi migrated a 6yo AWS infrastructure to GCP &mdash; Namshi Engineering</title>
    <!-- <link href="https://fonts.googleapis.com/css?family=Droid+Sans:400,700" rel="stylesheet" type="text/css"> -->

    <link rel="stylesheet" type="text/css" href="/stylesheets/prism.css">
    <link rel="stylesheet" type="text/css" href="/stylesheets/main.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/images/namshi-logo.png"/>
    <link href="/atom.xml" rel="alternate" type="application/rss+xml" title="Namshi Engineering" />
    <meta name="title" content="From cloud to cloud: how Namshi migrated a 6yo AWS infrastructure to GCP ">
    <link rel="canonical" href="http://namshi.github.io/blog/2019/01/15/from-cloud-to-cloud-how-namshi-migrated-a-6yo-aws-infrastructure-to-gcp/">
    
    
    <meta property="og:title" content="From cloud to cloud: how Namshi migrated a 6yo AWS infrastructure to GCP "/>
    <meta property="og:url" content="http://namshi.github.io/blog/2019/01/15/from-cloud-to-cloud-how-namshi-migrated-a-6yo-aws-infrastructure-to-gcp/"/>
    
    
    <meta property="og:site_name" content="Namshi Engineering">
</head>
<body>

<section class="site-nav">
    <header>
        <a class="brand" href="/">
          <img src="/images/namshi-logo.png" alt="Inc">
        </a>
        <a href="#" class="burger-icon"></a>
        <nav id="navigation">
            <a href="/" class="home">Blog</a>
            <a href="/team">Team</a>
            <a href="https://github.com/namshi">Github</a>
            <a href="/archives">Archives</a>
            <a class="join-us-link" href="/join-us/">HACK WITH US</a>
        </nav>
        <nav class="tagline">
            <!--<span>HACK WITH US</span>-->
            <a href="/join-us/" class="btn btn-outline">HACK WITH US</a>
        </nav>
    </header>
</section>


<article>

    <div class="container">
        <header>
            <div class="meta">
                <time pubdate datetime="2019-15-January" title="January 15, 2019">January 15, 2019</time>
            </div>
            <h1 class="title">From cloud to cloud: how Namshi migrated a 6yo AWS infrastructure to GCP</h1>
            
        </header>
        <footer>
            <address>
               
                <div class="author-pic">
                  <img src="/images/abz.png">
                </div>
               
                <p>Written by <strong><a rel="author" href="/team/#Abdelrahman Shiddo" title="Abdelrahman Shiddo">
                
                    Abdelrahman Shiddo
                
                </a></strong><br>
                <span class="muted">Senior Site Reliability Engineer</span>
                </p>
            </address>

        </footer>
        <section>
            <p>Our new year started with system-fireworks!</p>

<p><img class="center" src="/images/fireworks.png"></p>

<p>On January 1st, Namshi moved the majority of its infrastructure to Google Cloud Platform in order to take advantage of GKE, the incredible managed-Kubernetes service GCP offers. When you visit <em>namshi.com</em>, you will be served from the new infrastructure we migrated to, which includes our web applications as well as database servers.</p>

<p>This concludes an activity we initially thought of <strong>a year and a half ago</strong> and started working towards in Q2 2018.</p>

<p>In this post, we’d like to describe both how we migrated 6 years of infrastructure from AWS to GCP as well as the toughest challenges we faced along the way.</p>

<!-- more -->


<h2>Why the move?</h2>

<p>At Namshi, we heavily rely on Kubernetes to run our web services workloads as we aim for a microservices architecture. At first, we used <a href="https://www.saltstack.com/">Salt</a><a href="https://www.saltstack.com/">Stack</a> to provision our Kubernetes clusters on EC2 instances but later moved to <a href="https://github.com/kubernetes/kops">Kops</a> as it was easier to manage and create clusters, however it still felt a bit tacky.</p>

<p>We were looking for a cloud provider that integrated seamlessly with Kubernetes and looking at GKE, it was Kubernetes native which gave it a lot of advantages compared to others such as:</p>

<ul>
<li>managing networking and scaling</li>
<li>everything is one place, from the dashboards to draining a node to</li>
<li>pod logs and cluster metrics are sent automatically to Stackdriver which gives incredible insight</li>
<li>cluster upgrades are done within a click of a button</li>
</ul>


<h2>Planning</h2>

<p>We kicked off our journey by first meeting with the Google engineers, led by <a href="https://www.linkedin.com/in/ziad-jammal-656a5654/">Ziad</a>, to understand what GKE had to offer and how to fully take advantage of it. Other than our Kubernetes workload, we have databases running in RDS and Elasticache, so it was vital to know whether or not we ’d be migrating our databases. We also ran a good chunk of our workloads on <a href="https://tech.namshi.io/blog/2017/07/09/running-spot-instances-in-production/">spot instances</a>, so that’s something we would have like to keep on GCP.</p>

<p>Following the meeting, we concluded that using spot instances (aka preemptible nodes in GCP) to run a majority of our workload wouldn&rsquo;t be as straightforward due to the termination of instances after 24 hours and no guarantees in terms of termination notifications. We’d also have to find a way to replicate from RDS to CloudSQL and later promote it to master, as going the good old fashioned way of <code>mysqldump</code> would have been pretty risky. We compared MemoryStore to Elasticache and found that MemoryStore wasn&rsquo;t mature enough so we decided to stick to Elasticache in AWS.</p>

<p>Putting our staging environment on GCP was the first stepping stone to the big move. It was essential to get familiar with Stackdriver, managing the cluster from a simple UI, performance testing our applications with CloudSQL, however Elasticache and SQS were still running on AWS which may cause latency issues.  It also gave our devs a chance to play around with the powerful logging and monitoring tool Stackdriver has to offer, which they choose over Prometheus for application metrics.</p>

<h2>RDS Issues</h2>

<p>The most vital part of the whole migration was achieving a reliable/consistent replication process from RDS to CloudSQL.</p>

<p>Our first gut instinct was to use CloudSQL’s <a href="https://www.google.com/search?client=opera&amp;q=cloud+sql+migrate+data&amp;sourceid=opera&amp;ie=UTF-8&amp;oe=UTF-8">migrate data</a> feature that lets you replicate from an external source such as AWS or on-premise, but it required the source to have GTID enabled which AWS didn&rsquo;t have at the time. All our time went into finding a seamless method to replicate the data using tools like <a href="https://www.attunity.com/products/replicate/">Attunity Replicate</a> and <a href="https://www.percona.com/doc/percona-xtrabackup/2.4/index.html">Percona XtraBackup</a> that weren&rsquo;t very reliable because of how long it took (we also observed inconsistent data from import to import).</p>

<p>Luckily, on the 12th of October AWS announced the support of GTID on MySQL 5.7.23. This required downtime of around 10 minutes to upgrade our master instances and then replication would be as simple and reliable as ever from one MySQL instance to another across clouds using CloudSQL migrate data.</p>

<h2>Miscellaneous Issues</h2>

<p>Other than the RDS issues, we had a few issues here and there such as <a href="https://github.com/jtblin/kube2iam">kube2iam</a>, S3 and Elasticache latencies.</p>

<p>Kube2iam is an awesome tool that allows pods to authenticate using the EC2 nodes metadata instead of credentials. It made our lives a lot easier on AWS, but it wasn’t cloud agnostic at all. It required provisioning of new credentials and, in some cases, code changes to authenticate using credentials instead of metadata.</p>

<p>While running tests on a replica of our production environment on GCP, the latency to SQS, Elasticache and S3 in different regions was a few seconds &ndash; we expected some latency but nothing this crazy!
We decided to migrate a few important S3 buckets using the cross-replication policy, provision new SQS queues and an Elasticache cluster in regions closer to GCP that saw the latency drop back down to a few hundred milliseconds and we can live with that.</p>

<h2>Big night</h2>

<p>As the end of the year was approaching, we had to find the best time to perform the actual migration as it required 3 hours of downtime. We consulted our PM team about the scheduled downtime, turns out New Years 4 am was the best time to carry out such a risky and long migration.</p>

<p>Here’s a list of the actual migration steps we followed:</p>

<ul>
<li>inform all teams before the scheduled downtime</li>
<li>take down all services</li>
<li>lock writes to RDS</li>
<li>run data consistency tests for both AWS and Clouds SQL to ensure no discrepancies</li>
<li>cloud SQL instances were promoted to master</li>
<li>test website and applications internally</li>
<li>forward traffic from old cluster to new cluster in GCP in order to make sure that if a client doesn’t respect the DNS TTL we can still forward it to GCP</li>
<li>switch our public DNS to point to GCP</li>
</ul>


<p>Everything was followed as planned and the predicted timings we had for each task was spot on. However, nothing goes ever as planned as we had one problem due to insufficient memory on the new ElastiCahce instance which was fixed by upsizing the instance. Other than that, the whole migration seemed seamless and, for a second, we forgot how big of a task this was.</p>

<h2>Aftermath</h2>

<p>At 7 am on January 1st, we brought all of our services all backup and watched our monitoring systems for any issues or anything unexpected. It&rsquo;s a big relief to say that we didn’t get any complaints from customers and other than the downtime, it seemed like nothing had changed.</p>

<p>The same can’t be said for a few of our internal tools, where we noticed a few problems, but were mostly due to them still pointing to the wrong MySQL endpoint or S3 bucket. The fixes were pretty straightforward and everything in our internal tools were back to normal.</p>

<p>After ensuring everything was running fine on GCP, it was time to scale down our old Kubernetes cluster running on AWS, as well as remove any RDS and Elasticache replicas.</p>

<h2>Namshi still 💛 AWS</h2>

<p>Something we’d like to clarify is that we still rely on AWS for a bunch of services, as we believe a world of multiple clouds allows us to pick the right tool for the job. There are some services we think are more suitable to be kept in AWS, and decided against migrating them — we might revisit these decisions later on but, for now, we’re happy with where we are.</p>

<p>AWS has served as a strategic partner for Namshi for over a lustrum, so we’d like to mention that we’re not running away from a bad provider, but rather that we found GCP more suitable for the kind of workloads and stack Namshi runs on.</p>

<h2>In the end…</h2>

<p>We are very happy with this activity as it allows our infrastructure to run in an environment (GKE) that is more suitable for our stack. Additional benefits, like cost reductions and better integration with other parts of our stack (like data warehousing, which has been running on GCP since its inception), are secondary to the fact that we have eliminated in-house management of our Kubernetes clusters, a tedious activity we’d like GCP to take care of, in order to let us focus on our domain-specific challenges.</p>

<p>A special thank goes to <a href="https://tech.namshi.io/team/#Andrey%20Komarov">Andrey</a>, <a href="https://tech.namshi.io/team/#Carles%20Iborra">Carles</a> and <a href="https://tech.namshi.io/team/#Ayham%20Alzoubi">Ayham</a>, as they shared the burden of this legendary task along the way, and sacrificed their NYE to let Namshi take a step forward!</p>

            
            <footer>
                <span class="categories">Posted in <a class='category' href='/blog/categories/aws/'>aws</a>, <a class='category' href='/blog/categories/gcp/'>gcp</a>, <a class='category' href='/blog/categories/gke/'>gke</a>, <a class='category' href='/blog/categories/kubernetes/'>kubernetes</a>, <a class='category' href='/blog/categories/sre/'>sre</a></span>
            </footer>
            
            <!-- Go to www.addthis.com/dashboard to customize your tools -->
<div class="addthis_inline_share_toolbox"></div>
        </section>

        
        <section>
            <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'namshitechblog'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
        </section>
        
    </div>
</article>


<footer class="site-footer">
    <div class="container">
        &copy; 2020 <a href="https://tech.namshi.io">Namshi</a> &middot;
        
        <nav>
            <a href="/">Blog</a> &middot;
            <a href="/team">Team</a> &middot; 
            <a href="https://github.com/namshi">Github</a> &middot; 
            <a href="/join-us/">Careers</a> 
        </nav>

        <nav class="social">
            
            <a href="https://twitter.com/technamshi" title="Follow on Twitter" target="_blank"><i class="icon icon-twitter black"></i></a>
            
            
            <a href="http://facebook.com/NamshiFans" title="Follow on Facebook" target="_blank"><i class="icon icon-facebook black"></i></a>
            
            <a href="/atom.xml" title="RSS Feed">
                <i class="icon icon-rss black"></i>
            </a>
        </nav>
    </div>
</footer>

<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<script type="text/javascript" src="/javascripts/main.js"></script>
<script type="text/javascript" src="/javascripts/prism.js"></script>
<!-- Go to www.addthis.com/dashboard to customize your tools -->
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-57bdfe0617e09a06"></script>

  <!--google analytics tracking code here-->
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-27338864-10', 'auto');
    ga('send', 'pageview');
  </script>




</body>
</html>
