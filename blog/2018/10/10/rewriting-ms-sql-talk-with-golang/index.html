<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=0">
    <title>Rewriting an MS SQL gateway with Golang &mdash; Namshi Engineering</title>
    <!-- <link href="https://fonts.googleapis.com/css?family=Droid+Sans:400,700" rel="stylesheet" type="text/css"> -->

    <link rel="stylesheet" type="text/css" href="/stylesheets/prism.css">
    <link rel="stylesheet" type="text/css" href="/stylesheets/main.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/images/namshi-logo.png"/>
    <link href="/atom.xml" rel="alternate" type="application/rss+xml" title="Namshi Engineering" />
    <meta name="title" content="Rewriting an MS SQL gateway with Golang ">
    <link rel="canonical" href="http://namshi.github.io/blog/2018/10/10/rewriting-ms-sql-talk-with-golang/">
    
    
    <meta property="og:title" content="Rewriting an MS SQL gateway with Golang "/>
    <meta property="og:url" content="http://namshi.github.io/blog/2018/10/10/rewriting-ms-sql-talk-with-golang/"/>
    
    
    <meta property="og:site_name" content="Namshi Engineering">
</head>
<body>

<section class="site-nav">
    <header>
        <a class="brand" href="/">
          <img src="/images/namshi-logo.png" alt="Inc">
        </a>
        <a href="#" class="burger-icon"></a>
        <nav id="navigation">
            <a href="/" class="home">Blog</a>
            <a href="/team">Team</a>
            <a href="https://github.com/namshi">Github</a>
            <a href="/archives">Archives</a>
            <a class="join-us-link" href="/join-us/">HACK WITH US</a>
        </nav>
        <nav class="tagline">
            <!--<span>HACK WITH US</span>-->
            <a href="/join-us/" class="btn btn-outline">HACK WITH US</a>
        </nav>
    </header>
</section>


<article>

    <div class="container">
        <header>
            <div class="meta">
                <time pubdate datetime="2018-10-October" title="October 10, 2018">October 10, 2018</time>
            </div>
            <h1 class="title">Rewriting an MS SQL gateway with Golang</h1>
            
        </header>
        <footer>
            <address>
               
                <div class="author-pic">
                  <img src="/images/ming.png">
                </div>
               
                <p>Written by <strong><a rel="author" href="/team/#Ming Hu" title="Ming Hu">
                
                    Ming Hu
                
                </a></strong><br>
                <span class="muted">Junior Software Engineer</span>
                </p>
            </address>

        </footer>
        <section>
            <p>Innovation happens at an increasing rate today, which means code that is only one
or two years old might become outdated and hard to maintain.
In Namshi&rsquo;s Backend Team, we also discuss the best approach to fix issues
when we face problems caused by legacy code. Sometimes we do an incremental
refactor and other times we go for a complete rewrite.
This month we rewrote an app from scratch, and here is how we did it.</p>

<!-- more -->


<h3>Why?</h3>

<p>Namshi runs an app that acts as a gateway in front of an MS SQL server. We recently moved our MS SQL server to a different cloud provider, and our MS SQL gateway started to get stuck (taking more than 10 seconds to respond), causing slow operations in the apps relying on the gateway. We received daily (and nightly) calls due to slow response and needed to restart the app quite often. The limited amount of logging also made it hard for us to pinpoint the bottleneck. The app was also written in C#, a less used language in our team, and requires more attention.</p>

<p>Refactoring the code gives us the ease of not needing to go through a full development and testing cycle. However, the app might still get stuck and take huge effort to debug and maintain. On the other hand, a complete rewrite will improve stability, the logging system as well as easier performance management.</p>

<p>Considering the benefits of each approach, we decided to give it a complete rewrite.</p>

<h3>How?</h3>

<p>First we went out scouting for a driver. The driver we started with was the <a href="https://www.npmjs.com/package/mssql">Node.JS driver</a>. It was easy to use. However, it requires to specify SQL variable type when we create prepared statement. Our existing queries do not specify the SQL type for parameters, so it&rsquo;s painful to add all the fields. So, we decided to opt for a second choice, the <a href="https://github.com/denisenkom/go-mssqldb">Golang driver</a>. Golang has been popular in the backend team. We love it for its simplicity, performance, concurrency as well as its rapid development and growing community. Check out below the difference of creating prepared statement with NodeJS and Golang drivers:</p>

<figure class='code'><figcaption><span></span></figcaption><pre><code class='language-javascript'>/* Node driver: create prepared statements */
const ps = new sql.PreparedStatement(/* [pool] */)
/* We need to specify the SQL type of parameters */
ps.input(&apos;param&apos;, sql.Int)
ps.prepare(&apos;select @param as value&apos;, err =&gt; {
    // ... error checks
    ps.execute({param: 12345}, (err, result) =&gt; {
        // ... error checks
        ps.unprepare(err =&gt; {
            // ... error checks
        })
    })
})</code></pre></figure>




<figure class='code'><figcaption><span></span></figcaption><pre><code class='language-go'>// Golang driver: create prepared statements
// We don&apos;t need to specify the SQL type of parameters
db.QueryContext(ctx, `select * from t where ID = @ID and Name = @p2;`, sql.Named(&quot;ID&quot;, 6), &quot;Bob&quot;)</code></pre></figure>


<p>To run an MS SQL Server locally, we used this <a href="https://hub.docker.com/r/microsoft/mssql-server-linux/">Docker Image</a> and created a test database for rapid prototyping. Our first snippet of code only had a single function to execute a dummy query against the database.</p>

<p>From there, we started implementing the app as per the old <code>README</code>. We had to battle with taking care of data types (e.g, casting DECIMAL to float, or formatting dates correctly for MSSQL), use transactions in write queries and use connection pooling to enhance performance. For logging, we add logs for the time each query takes and the specific parameters each query uses. It becomes much easier for future troubleshooting and debugging.</p>

<h3>Rollout</h3>

<p>Rolling out a critical app requires careful planning. To start with, we rolled out the apps on staging and ran test queries to make sure everything worked fine. Then we switched a few live apps on a separate service and kept them running for a period of time. After couple days, we rolled out more live apps and fixed bugs as they came. A week later, we switched all live apps and checked logs closely to make sure all went well.</p>

<h3>Outcome</h3>

<p>With this rewrite we achieved much better performance. The integration with New Relic lets us check app performance in real time and figure out what is causing performance issue. Detailed logging allows us to debug and improve code rapidly. More importantly, this new app is well understood by the team and has been very stable since we switched. We are not receiving daily or nightly calls any more :).</p>

            
            <footer>
                <span class="categories">Posted in <a class='category' href='/blog/categories/mssql/'>mssql</a></span>
            </footer>
            
            <!-- Go to www.addthis.com/dashboard to customize your tools -->
<div class="addthis_inline_share_toolbox"></div>
        </section>

        
        <section>
            <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'namshitechblog'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
        </section>
        
    </div>
</article>


<footer class="site-footer">
    <div class="container">
        &copy; 2019 <a href="https://tech.namshi.io">Namshi</a> &middot;
        
        <nav>
            <a href="/">Blog</a> &middot;
            <a href="/team">Team</a> &middot; 
            <a href="https://github.com/namshi">Github</a> &middot; 
            <a href="/join-us/">Careers</a> 
        </nav>

        <nav class="social">
            
            <a href="https://twitter.com/technamshi" title="Follow on Twitter" target="_blank"><i class="icon icon-twitter black"></i></a>
            
            
            <a href="http://facebook.com/NamshiFans" title="Follow on Facebook" target="_blank"><i class="icon icon-facebook black"></i></a>
            
            <a href="/atom.xml" title="RSS Feed">
                <i class="icon icon-rss black"></i>
            </a>
        </nav>
    </div>
</footer>

<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<script type="text/javascript" src="/javascripts/main.js"></script>
<script type="text/javascript" src="/javascripts/prism.js"></script>
<!-- Go to www.addthis.com/dashboard to customize your tools -->
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-57bdfe0617e09a06"></script>

  <!--google analytics tracking code here-->
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-27338864-10', 'auto');
    ga('send', 'pageview');
  </script>




</body>
</html>
