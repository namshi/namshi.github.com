<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=0">
    <title>Docker security improvement - User namespace &mdash; Namshi Engineering</title>
    <!-- <link href="https://fonts.googleapis.com/css?family=Droid+Sans:400,700" rel="stylesheet" type="text/css"> -->

    <link rel="stylesheet" type="text/css" href="/stylesheets/prism.css">
    <link rel="stylesheet" type="text/css" href="/stylesheets/main.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/images/namshi-logo.png"/>
    <link href="/atom.xml" rel="alternate" type="application/rss+xml" title="Namshi Engineering" />
    <meta name="title" content="Docker security improvement - User namespace ">
    <link rel="canonical" href="http://namshi.github.io/blog/2016/03/09/docker-security-improvement-username-space/">
    
    
    <meta property="og:title" content="Docker security improvement - User namespace "/>
    <meta property="og:url" content="http://namshi.github.io/blog/2016/03/09/docker-security-improvement-username-space/"/>
    
    
    <meta property="og:site_name" content="Namshi Engineering">
</head>
<body>

<section class="site-nav">
    <header>
        <a class="brand" href="/">
          <img src="/images/namshi-logo.png" alt="Inc">
        </a>
        <a href="#" class="burger-icon"></a>
        <nav id="navigation">
            <a href="/" class="home">Blog</a>
            <a href="/team">Team</a>
            <a href="https://github.com/namshi">Github</a>
            <a href="/archives">Archives</a>
            <a class="join-us-link" href="/join-us/">HACK WITH US</a>
        </nav>
        <nav class="tagline">
            <!--<span>HACK WITH US</span>-->
            <a href="/join-us/" class="btn btn-outline">HACK WITH US</a>
        </nav>
    </header>
</section>


<article>

    <div class="container">
        <header>
            <div class="meta">
                <time pubdate datetime="2016-09-March" title="March 09, 2016">March 09, 2016</time>
            </div>
            <h1 class="title">Docker security improvement - User namespace</h1>
            
        </header>
        <footer>
            <address>
               
                <p>Written by <strong><a rel="author" href="/team/#David Funaro" title="David Funaro">
                
                    David Funaro
                
                </a></strong><br>
                <span class="muted"></span>
                </p>
            </address>

        </footer>
        <section>
            <p>With the 1.10 release, Docker added a huge list of new features. Whith this post we are going do analyze one of options: username spaces.</p>

<p>Prior to version 1.10, running an alpine container mounting an external volume <code>/var/log/</code> was done as follows:</p>

<!-- more -->


<p><img class="center" src="/images/posts/docker-share-volume.png"></p>

<figure class='code'><pre><code class='language-bash'>➜  ~  docker run -it --rm -v /var/log:/var/log --name=demo alpine ls -latr /var/log/
total 35236
drwxr-xr-x    2 root     root          4096 Oct  5 15:57 apt
drwxr-xr-x    2 root     root          4096 Oct 20 16:18 dist-upgrade
-rw-r-----    1 root     adm             31 Oct 21 17:28 dmesg
-rw-r--r--    1 root     root         72557 Oct 21 17:29 bootstrap.log
drwxr-xr-x    2 root     root          4096 Nov  5 08:19 fsck
drwxr-xr-x    3 root     root          4096 Nov  5 08:49 installer
-rw-r-----    1 root     adm           6378 Dec 15 12:18 apport.log.1
drwxr-x---    2 root     adm           4096 Dec 17 06:04 unattended-upgrades
-rw-r-----    1 104      adm        1351288 Dec 19 05:56 syslog.2.gz
-rw-r-----    1 104      adm         402127 Dec 25 06:17 auth.log.1
-rw-r-----    1 104      adm        8667895 Dec 25 06:17 kern.log.1
-rw-r-----    1 104      adm         932806 Dec 25 06:21 syslog.1</code></pre></figure>


<p>Notice that the docker deamon is running with no additional options.</p>

<figure class='code'><pre><code class='language-bash'>➜  ~  ps -ef | grep -i daemon
root      21636      1  2 15:04 ?        00:00:00 /usr/bin/docker daemon -H fd://</code></pre></figure>


<p>The ownership of the files in the container is exactly same as the host. The user inside the container as full rights to the files. With this access, the user can even delete the files which will delete the files in the host as well. This is the problem!</p>

<p>Running the same code with Docker 1.10, adding the new option <code>--userns-remap=default</code> to the deamon, this results to:</p>

<figure class='code'><pre><code class='language-bash'>➜  ~  ps -ef | grep -i daemon
root      21636      1  2 15:04 ?        00:00:00 /usr/bin/docker daemon -H fd:// --userns-remap=default</code></pre></figure>


<p>As seen below, the deamon is running with an additional option <code>--userns-remap=default</code>.</p>

<figure class='code'><pre><code class='language-bash'>➜  ~  docker run -it --rm -v /var/log:/var/log --name=demo alpine ls -latr /var/log/
total 35260
drwxr-xr-x    2 nobody   nobody        4096 Oct  5 15:57 apt
drwxr-xr-x    2 nobody   nobody        4096 Oct 20 16:18 dist-upgrade
-rw-r-----    1 nobody   nobody          31 Oct 21 17:28 dmesg
-rw-r--r--    1 nobody   nobody       72557 Oct 21 17:29 bootstrap.log
drwxr-xr-x    2 nobody   nobody        4096 Nov  5 08:19 fsck
drwxr-xr-x    3 nobody   nobody        4096 Nov  5 08:49 installer
-rw-r-----    1 nobody   nobody        6378 Dec 15 12:18 apport.log.1
drwxr-x---    2 nobody   nobody        4096 Dec 17 06:04 unattended-upgrades
-rw-r-----    1 nobody   nobody     1351288 Dec 19 05:56 syslog.2.gz
-rw-r-----    1 nobody   nobody      402127 Dec 25 06:17 auth.log.1
-rw-r-----    1 nobody   nobody     8667895 Dec 25 06:17 kern.log.1
-rw-r-----    1 nobody   nobody      932806 Dec 25 06:21 syslog.1</code></pre></figure>


<p>The result is, owner is <code>nobody</code> now. Even the  root user of the container cannot change the files. This is a great security upgrade that everybody was waiting for.</p>

<blockquote><p>This feature saved us from working for a custom solution to tackle this problem.</p></blockquote>

<ul>
<li>image source: <a href="https://medium.com/on-docker/what-s-montague-docker-user-problems-and-patterns-79750c504aa1#.pmer584z9">Jeff Nickoloff &ndash; on-docker Blog</a></li>
</ul>


            
            <footer>
                <span class="categories">Posted in <a class='category' href='/blog/categories/docker/'>docker</a></span>
            </footer>
            
            <!-- Go to www.addthis.com/dashboard to customize your tools -->
<div class="addthis_inline_share_toolbox"></div>
        </section>

        
        <section>
            <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'namshitechblog'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
        </section>
        
    </div>
</article>


<footer class="site-footer">
    <div class="container">
        &copy; 2020 <a href="https://tech.namshi.io">Namshi</a> &middot;
        
        <nav>
            <a href="/">Blog</a> &middot;
            <a href="/team">Team</a> &middot; 
            <a href="https://github.com/namshi">Github</a> &middot; 
            <a href="/join-us/">Careers</a> 
        </nav>

        <nav class="social">
            
            <a href="https://twitter.com/technamshi" title="Follow on Twitter" target="_blank"><i class="icon icon-twitter black"></i></a>
            
            
            <a href="http://facebook.com/NamshiFans" title="Follow on Facebook" target="_blank"><i class="icon icon-facebook black"></i></a>
            
            <a href="/atom.xml" title="RSS Feed">
                <i class="icon icon-rss black"></i>
            </a>
        </nav>
    </div>
</footer>

<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<script type="text/javascript" src="/javascripts/main.js"></script>
<script type="text/javascript" src="/javascripts/prism.js"></script>
<!-- Go to www.addthis.com/dashboard to customize your tools -->
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-57bdfe0617e09a06"></script>

  <!--google analytics tracking code here-->
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-27338864-10', 'auto');
    ga('send', 'pageview');
  </script>




</body>
</html>
